# =============================================================================
# GitBook ë¬¸ì„œ ë³€ê²½ â†’ Jira í‹°ì¼“ ìžë™ ìƒì„±
# =============================================================================
# ê¸°íšíŒ€ì´ GitBookì„ í†µí•´ docs/ í´ë”ì— pushí•˜ë©´
# AIê°€ ë³€ê²½ì ì„ ë¶„ì„í•˜ì—¬ í•„ìš”í•œ ê²½ìš° Jira í‹°ì¼“ì„ ìžë™ ìƒì„±í•©ë‹ˆë‹¤.
#
# í•„ìš”í•œ GitHub Secrets:
# - JIRA_URL: https://your-company.atlassian.net
# - JIRA_USERNAME: your.email@company.com
# - JIRA_API_TOKEN: Jira API í† í°
# - JIRA_PROJECT_KEY: Jira í”„ë¡œì íŠ¸ í‚¤ (ì˜ˆ: SLEEP)
# - ANTHROPIC_API_KEY: Claude API í‚¤
# =============================================================================

name: GitBook to Jira

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.mdx'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry Run (í‹°ì¼“ ìƒì„± ì—†ì´ ë¶„ì„ë§Œ)'
        type: boolean
        default: false

jobs:
  detect-and-create:
    name: ðŸ“„ Analyze Docs & Create Tickets
    runs-on: ubuntu-latest
    
    services:
      mcp-atlassian:
        image: ghcr.io/sooperset/mcp-atlassian:latest
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          READ_ONLY_MODE: ${{ inputs.dry_run == true }}
        ports:
          - 9000:9000

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changes
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^docs/.*\.(md|mdx)$' || true)
          
          if [ -z "$FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files=$(echo "$FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changed: $FILES"
          fi

      - name: Setup Node.js
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for MCP server
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:9000/health > /dev/null 2>&1; do sleep 2; done' || true

      - name: Analyze and create tickets
        if: steps.changes.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MCP_SERVER_URL: 'http://localhost:9000'
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          DRY_RUN: ${{ inputs.dry_run || false }}
          JIRA_URL: ${{ secrets.JIRA_URL }}
        run: node .github/scripts/analyze-docs.js

      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ“‹ Results" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/created_tickets.json ]; then
            echo "### Created Tickets:" >> $GITHUB_STEP_SUMMARY
            cat /tmp/created_tickets.json | jq -r '.[] | "- [\(.key)](\(.url)): \(.summary)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No tickets created" >> $GITHUB_STEP_SUMMARY
          fi